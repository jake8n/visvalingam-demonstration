<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Visvalingam demonstration</title>
    <style>
      html {
        color: #111;
        font-family: sans-serif;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <h1>Visvalingam demonstration</h1>
      <h2>canvas width <span id="canvas-width"></span> pixels</h2>
      <h2># points <span id="points-length"></span></h2>
      <canvas width="720" height="360" id="canvas"></canvas>
    </div>

    <script type="module">
      import aapl from './public/aapl.js'
      import { simplify } from './public/simplify.js'
      import { clearCanvas, useChart } from './public/chart.js'

      function sleep(ms) {
        return new Promise((resolve, reject) => {
          setTimeout(() => {
            resolve()
          }, ms)
        })
      }

      const canvas = document.querySelector('#canvas')
      const canvasWidthEl = document.querySelector('#canvas-width')
      const pointsLengthEl = document.querySelector('#points-length')

      async function run() {
        canvasWidthEl.innerHTML = canvas.width

        let stocks = aapl
        try {
          while (stocks.length > 2) {
            stocks = simplify(stocks)
            clearCanvas(canvas)
            useChart(canvas, stocks)
            pointsLengthEl.innerHTML = stocks.length
            await sleep(20)
          }
        } catch (err) {
          console.error(err)
        }
      }

      run()
    </script>
  </body>
</html>
